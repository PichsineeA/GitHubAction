name: Manual Backup Deploy
run-name: Manual Backup Deploy-${{ inputs.environment }}

on:
  workflow_dispatch:
    inputs:
      environment:
        type: environment
        description: 'Select the environment'
        required: True
        
jobs:

  backup:
    runs-on: self-hosted #[ self-hosted ]
    environment: ${{ inputs.environment }}
    
    steps:
      - name: superset Checkout
        uses: actions/checkout@v2
        with:
            ref: ${{github.ref_name}}
            fetch-depth: 0

      - name: Backup-${{ inputs.environment }}
        run: |
            chmod +x ./pipeline_script_github/backup.sh
            ./pipeline_script_github/backup.sh
            
        env:
            ENV_NAME: ${{ inputs.environment }}
            ENV_HOST: ${{ secrets.ENV_HOST }}
            ENV_PASS: ${{ secrets.ENV_PASS }} 
            ENV_USER: ${{ secrets.ENV_USER }}
            COMMIT: ${GITHUB_SHA::7}

            
      - name: Upload backup artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.environment }}-${{github.sha}}
          path: pipeline_script_github/backup/

      - name: Cache Dependencies
        uses: actions/cache@v2
        with:
          path: pipeline_script_github/backup/
          key: ${{ runner.OS }}-${{ inputs.environment }}-${{ inputs.version }}
          restore-keys: |
            ${{ runner.os }}-zip-


  deploy:
    runs-on: [ self-hosted ]
    environment: ${{ inputs.environment }}
    needs: [backup]
    
    steps:
      - name: superset Checkout
        uses: actions/checkout@v2
        with:
            ref: ${{github.ref_name}}
            fetch-depth: 0

      - name: deploy
        run: |
            chmod +x ./pipeline_script_github/deploy.sh
            ./pipeline_script_github/deploy.sh
            
        env:
            ENV_NAME: ${{ inputs.environment }}
            CI_COMMIT_TAG: ${{github.ref_name}}
            ENV_HOST: ${{secrets.ENV_HOST}}
            ENV_PASS: ${{secrets.ENV_PASS}}  
            ENV_USER: ${{secrets.ENV_USER}}
