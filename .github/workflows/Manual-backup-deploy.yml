name: Manual Backup Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        type: environment
        description: 'Select the environment'
        required: True
        
jobs:

  backup:
    runs-on: [ ubuntu-latest ]
    environment: ${{ inputs.environment }}
    
    steps:
      - name: superset Checkout
        uses: actions/checkout@v2
        with:
            ref: ${{github.ref_name}}
            fetch-depth: 0

      - name: Backup
        run: |
            ./pipeline_script_github/backup.sh
        env:
            ENV_NAME: ${{ inputs.environment }}
            DB_HOST: ${{ secrets.DB_HOST }}
            DB_PASS: ${{ secrets.DB_PASS }} 
            DB_USER: ${{ secrets.DB_USER }}
            COMMIT: ${GITHUB_SHA::7}

            
      - name: Upload backup artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.environment }}-${{github.sha}}
          path: "./pipeline_script_github/backup/${{ inputs.environment }}_backup_assets.zip"


  deploy:
    runs-on: [ ubuntu-latest ]
    environment: ${{ inputs.environment }}
    needs: [backup]
    
    steps:
      - name: superset Checkout
        uses: actions/checkout@v2
        with:
            ref: ${{github.ref_name}}
            fetch-depth: 0

      - name: deploy
        run: |
            ./pipeline_script_github/deploy.sh
        env:
            ENV_NAME: ${{ inputs.environment }}
            CI_COMMIT_TAG: ${{github.ref_name}}
            DB_HOST: ${{secrets.DB_HOST}}
            DB_PASS: ${{secrets.DB_PASS}}  
            DB_USER: ${{secrets.DB_USER}}
